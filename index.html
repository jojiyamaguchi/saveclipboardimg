<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      .paste-box {
        background : rgb(0,200,50);
        &:empty::before {
          content:'ここに画像をペーストしてください (Ctrl+V/⌘+V).';
          font-size:3vh;
          width:90%;
          display:inline-block;
          color:#ccc;
          
       }
       
       /* Hide the default text onFocus */
       &:focus::before{
          color:transparent;
       }
      }
    </style>
  </head>
  <body>
    <div class="container">
    <div id="canvas_div">
      <div id="cdiv">
        <div class="paste-box" id="box" contenteditable="true"></div>
        <button type="button" onclick="aClick()">ダウンロード準備</button>
        <a href="" id="ss" download="html_ss.png">ペーストした画像をダウンロード</a>
      </div>
      <img src="" id="result" />
      <div id="debug_div"></div>
    </div>
  </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.js"></script>
    <script>

      //document.querySelector('div[id="box"]').addEventListener('paste', function(e) {
      //document.querySelector('div[id="box"]').addEventListener('change', function(e) {
      function aClick(){
        let children = document.getElementById("box").childNodes;

        let imgNode;
        if(children.length > 0) {
          imgNode = children[0];
          document.getElementById("result").src = imgNode.src;
        }

        document.getElementById("debug_div").innerHTML = "children=" + children.length;
      }
      function waitForElement(selector, callback, intervalMs, timeoutMs) {
          const startTimeInMs = Date.now();
          findLoop();

          function findLoop() {
              if (document.querySelector(selector) != null) {
                  callback();
                  return;
              } else {
                  setTimeout(() => {
                      if (timeoutMs && Date.now() - startTimeInMs > timeoutMs) return;
                      findLoop();
                  }, intervalMs);
              }
          }
      }

      document.querySelector('div[id="box"]').addEventListener('paste', function(e) {
        waitForElement('div#box img', nodeaddCallback, 500, 10000);
      });

      function nodeaddCallback(){
        let children = document.getElementById("box").childNodes;
        let imgNode;
        if(children.length > 0) {
          imgNode = children[0];
          document.getElementById("result").src = imgNode.src;
        }
        document.getElementById("debug_div").innerHTML = "待機成功";       
      }
        /*
        //HTML内に画像を表示
        html2canvas(document.getElementById("box"),{
          onrendered: function(canvas){
            //imgタグのsrcの中に、html2canvasがレンダリングした画像を指定する。
            var imgData = canvas.toDataURL();
            document.getElementById("result").src = imgData;
          }
        });
  
        //ボタンを押下した際にダウンロードする画像を作る
        html2canvas(document.getElementById("box"),{
          onrendered: function(canvas){
            //aタグのhrefにキャプチャ画像のURLを設定
            var imgData = canvas.toDataURL();
            document.getElementById("ss").href = imgData;
          }
        });*/
      //});
    </script>
  </body>
</html>

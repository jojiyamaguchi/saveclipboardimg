<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      .paste-box {
        background : rgb(0,200,50);
        &:empty::before {
          content:'ここに画像をペーストしてください (Ctrl+V/⌘+V).';
          font-size:3vh;
          width:90%;
          display:inline-block;
          color:#ccc;
          
       }
       
       /* Hide the default text onFocus */
       &:focus::before{
          color:transparent;
       }
      }
    </style>
  </head>
  <body>
    <div class="container" id="parent-box">
      <div class="paste-box" id="box" contenteditable="true"></div>
      <button type="button" onclick="aClick()">ダウンロード準備</button>
      <a href="" id="ss" download="save_clipboard_img.png">ペーストした画像をダウンロード</a>
      <canvas id="decode-canvas"></canvas>
      <img src="" id="result"></img>
      <div id="debug_div"></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.js"></script>
    <script>

      function waitForElement(selector, callback, intervalMs, timeoutMs) {
          const startTimeInMs = Date.now();
          findLoop();

          function findLoop() {
              if (document.querySelector(selector) != null) {
                  callback();
                  return;
              } else {
                  setTimeout(() => {
                      if (timeoutMs && Date.now() - startTimeInMs > timeoutMs) return;
                      findLoop();
                  }, intervalMs);
              }
          }
      }

      document.querySelector('div[id="box"]').addEventListener('paste', function(e) {
        waitForElement('div#box img', nodeaddCallback, 500, 10000);
      });

      function nodeaddCallback(){
        let children = document.getElementById("box").childNodes;
        let imgNode;
        if(children.length > 0) {
          imgNode = children[0];
          document.getElementById("result").src = imgNode.src;
          document.getElementById("debug_div").innerHTML = imgNode.src;
/*
          var canvas = document.getElementById("decode-canvas");
          var ctx = canvas.getContext( '2d' );
          var sw = imgNode.naturalWidth;
          var sh = imgNode.naturalHeight;
          ctx.drawImage(imgNode, 0, 0, sw, sh);
          var dataURL = canvas.toDataURL();
*/
          // (1)ファイルをバイナリ化
          let bin = atob(imgNode.src.replace(/^.*,/, ''));

          // (2)バイナリデータに変換する
          let buffer = new Uint8Array(bin.length);
          for (let i = 0; i < bin.length; i++) {
              buffer[i] = bin.charCodeAt(i);
          }

          // (3)Fileオブジェクトを生成
          let image_file = new File([buffer.buffer], "save_clipboard_img.png", {type: "image/png"});


          let NewANode = document.createElement("a");
          NewANode.href = "";
          NewANode.download = image_file.name;
          NewANode.innerHTML = "ここをクリックして画像を保存してください";
          document.getElementById("parent-box").appendChild(NewANode);
        }
      }

    </script>
  </body>
</html>
